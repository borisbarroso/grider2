/*
	ufd 0.4 : Unobtrusive Fast-filter Drop-down jQuery plugin.

	Authors:
		thetoolman@gmail.com 
		Kadalashvili.Vladimir@gmail.com

	Version:  0.4

	Website: http://code.google.com/p/ufd/
 */
(function($){$.widget("ui.ufd",{_init:function(){if(this.element[0].tagName.toLowerCase()!="select"){this.destroy();return false;}this.selectbox=this.element;this.logNode=$(this.options.logSelector);this.overflowCSS=this.options.allowLR?"overflow":"overflowY";var selectName=this.selectbox.attr("name");var suffixName=selectName+this.options.suffix;var inputName=this.options.submitFreeText?selectName:suffixName;if(this.options.submitFreeText)this.selectbox.attr("name",suffixName);this.wrapper=$('<span class="ufd invisible '+this.options.skin+'"  >'+'<input type="text" autocomplete="off" value="" name="'+inputName+'"/>'+'<button tabindex="-1" type="button"><div class="icon"/></button>'+'</span>');this.dropdown=$('<div class="'+this.options.skin+'">'+'<div class="list-wrapper invisible">'+'<div class="list-scroll">'+'</div>'+'</div>'+'</div>');this.selectbox.after(this.wrapper);this.getDropdownContainer().append(this.dropdown);this.input=this.wrapper.find("input");this.button=this.wrapper.find("button");this.listWrapper=this.dropdown.find(".list-wrapper");this.listScroll=this.dropdown.find(".list-scroll");if($.fn.bgiframe)this.listWrapper.bgiframe();this.listMaxHeight=this.getListMaxHeight();this._populateFromMaster();this._initEvents();},_initEvents:function(){var self=this;var keyCodes=$.ui.keyCode;var key,isKeyDown,isKeyPress,isKeyUp;self.input.bind("keydown keypress keyup",function(event){isKeyDown=(event.type=="keydown");isKeyPress=(event.type=="keypress");isKeyUp=(event.type=="keyup");key=null;if(undefined===event.which){key=event.keyCode;}else if(!isKeyPress&&event.which!=0){key=event.keyCode;}else{return;}if(!isKeyUp==((key!=keyCodes.TAB)&&(key!=keyCodes.ENTER)))return;self.lastKey=key;switch(key){case keyCodes.SHIFT:case keyCodes.CONTROL:break;case keyCodes.DOWN:self.selectNext(false);break;case keyCodes.PAGE_DOWN:self.selectNext(true);break;case keyCodes.END:self.selectLast();break;case keyCodes.UP:self.selectPrev(false);break;case keyCodes.PAGE_UP:self.selectPrev(true);break;case keyCodes.HOME:self.selectFirst();break;case keyCodes.ENTER:self.hideList();self.tryToSetMaster();self.inputFocus();self.stopEvent(event);break;case keyCodes.TAB:self.realLooseFocusEvent();break;case keyCodes.ESCAPE:self.hideList();self.revertSelected();break;default:self.showList();self.filter(0,true);break;}});this.input.bind("click focus",function(e){if(self.isDisabled){self.stopEvent(e);return;}if(!self.internalFocus){self.realFocusEvent();}});this.button.bind("mouseover",function(e){self.button.addClass("hover");});this.button.bind("mouseout",function(e){self.button.removeClass("hover");});this.button.bind("mousedown",function(e){self.button.addClass("mouseDown");});this.button.bind("mouseup",function(e){self.button.removeClass("mouseDown");});this.button.bind("click",function(e){if(self.isDisabled){self.stopEvent(e);return;}if(self.listVisible()){self.hideList();self.inputFocus();}else{self.filter(1);self.inputFocus();self.showList();self.scrollTo();}});this.listWrapper.bind("mouseover mouseout click",function(e){if("LI"==e.target.nodeName.toUpperCase()){if(self.setActiveTimeout){clearTimeout(self.setActiveTimeout);self.setActiveTimeout==null;}if("mouseout"==e.type){$(e.target).removeClass("active");self.setActiveTimeout=setTimeout(function(){$(self.selectedLi).addClass("active");},self.options.delayYield);}else if("mouseover"==e.type){if(self.selectedLi!=e.target){$(self.selectedLi).removeClass("active");}$(e.target).addClass("active");}else{self.stopEvent(e);var value=$.trim($(e.target).text());self.input.val(value);self.setActive(e.target);if(self.tryToSetMaster()){self.hideList();self.filter(1);}self.inputFocus();}}return true;});this.selectbox.bind("change",function(e){if(self.isUpdatingMaster){self.isUpdatingMaster=false;return true;}self.log("master changed; reverting");self.revertSelected();});$(document).bind("click",function(e){if((self.button.get(0)==e.target)||(self.input.get(0)==e.target))return;if(self.internalFocus)self.realLooseFocusEvent();});},realFocusEvent:function(){this.internalFocus=true;this._triggerEventOnMaster("focus");this.filter(1);this.inputFocus();this.showList();this.scrollTo();},realLooseFocusEvent:function(){this.internalFocus=false;this.hideList();this.tryToSetMaster();this._triggerEventOnMaster("blur");},_triggerEventOnMaster:function(eventName){if(document.createEvent){var evObj=document.createEvent('HTMLEvents');evObj.initEvent(eventName,true,true);this.selectbox.get(0).dispatchEvent(evObj);}else if(document.createEventObject){this.selectbox.get(0).fireEvent("on"+eventName);}},inputFocus:function(){this.input.focus();if(this.getCurrentTextValue().length){this.selectAll();}},inputBlur:function(){this.input.blur();},showList:function(){if(this.listVisible())return;this.listWrapper.removeClass("invisible");this.setListDisplay();},hideList:function(){if(!this.listVisible())return;this.listWrapper.addClass("invisible");this.listItems.removeClass("invisible");},filter:function(showAllLength,doDelay){var self=this;if(this.updateOnTimeout)clearTimeout(this.updateOnTimeout);if(this.filterOnTimeout)clearTimeout(this.filterOnTimeout);this.updateOnTimeout=null;this.filterOnTimeout=null;var search=function(){var mm=self.trie.findPrefixMatchesAndMisses(self.getCurrentTextValue());self.trie.matches=mm.matches;self.trie.misses=mm.misses;self.updateOnTimeout=setTimeout(function(){screenUpdate();},self.options.delayYield);};var screenUpdate=function(){var active=self.getActive();self.overwriteClass(self.trie.matches,"");if(self.trie.matches.length<=showAllLength){self.overwriteClass(self.trie.misses,"");}else{self.overwriteClass(self.trie.misses,"invisible");}var oldActiveVisible=(active.length&&!active.hasClass("invisible"));if(oldActiveVisible){self.setActive(active.get(0));}else if(self.trie.matches.length){var firstmatch=self.trie.matches[0];self.setActive(firstmatch[0]);}else if(!self.options.submitFreeText){self.selectFirst();}self.setListDisplay();};if(doDelay){this.filterOnTimeout=setTimeout(function(){search();},this.options.delayFilter);}else{search();}},tryToSetMaster:function(){if(this.selectedLi==null&&!this.options.submitFreeText){this.log("not allowed freetext, revert:");this.revertSelected();return false;}var active=this.getActive();if(!active.length){this.log("No selected item.");return false;}var optionIndex=active.attr("name");if(optionIndex==null||optionIndex==""||optionIndex<0){this.log("No selected item.");return false;}var sBox=this.selectbox.get(0);var curIndex=sBox.selectedIndex;var option=sBox.options[optionIndex];var optionValue=option.value||option.text;if(optionIndex==curIndex){return true;}this.isUpdatingMaster=true;sBox.selectedIndex=optionIndex;if(this.selectbox.val()!=optionValue){this.log("set failed!");sBox.selectedIndex=curIndex;this.selectbox.val(curIndex);if(!this.options.submitFreeText){this.revertSelected();}return false;}this.input.val(option.text);this._triggerEventOnMaster("change");return true;},_populateFromMaster:function(){this.disable();this.setDimensions();this.trie=new Trie(this.options.caseSensitive);this.trie.matches=[];this.trie.misses=[];var self=this;var listBuilder=[];var trieObjects=[];listBuilder.push('<ul>');var options=this.selectbox.get(0).options;var thisOpt,loopCountdown,index;loopCountdown=options.length;index=0;do{thisOpt=options[index++];listBuilder.push('<li name="'+thisOpt.index+'">'+$.trim(thisOpt.text)+'</li>');}while(--loopCountdown);listBuilder.push('</ul>');this.listScroll.html(listBuilder.join(''));this.list=this.listScroll.find("ul:first");this.listItems=$("li",this.list);var theLiSet=this.list.get(0).getElementsByTagName('LI');loopCountdown=theLiSet.length;index=0;do{thisOpt=options[index];self.trie.add($.trim(thisOpt.text),theLiSet[index++]);}while(--loopCountdown);if(this.options.triggerSelected){this.setInputFromMaster();}else{this.input.val("");}this.enable();},setDimensions:function(){this.wrapper.addClass("invisible");if(this.selectIsWrapped){this.wrapper.before(this.selectbox);}this.originalSelectboxWidth=this.selectbox.outerWidth();var props=["marginLeft","marginTop","marginRight","marginBottom"];for(propPtr in props){var prop=props[propPtr];this.wrapper.css(prop,this.selectbox.css(prop));}this.wrapper.get(0).appendChild(this.selectbox.get(0));this.wrapper.removeClass("invisible");this.selectIsWrapped=true;var newSelectWidth=this.originalSelectboxWidth;if(this.options.manualWidth){newSelectWidth=this.options.manualWidth;}else if(newSelectWidth<this.options.minWidth){newSelectWidth=this.options.minWidth;}var buttonWidth=this.button.outerWidth();var inputBP=this.input.outerWidth()-this.input.width();var inputWidth=newSelectWidth-buttonWidth-inputBP;var listWrapBP=this.listWrapper.outerWidth()-this.listWrapper.width();this.input.width(inputWidth);this.wrapper.width(newSelectWidth);this.listWrapper.width(newSelectWidth-listWrapBP);this.listScroll.width(newSelectWidth-listWrapBP);},setInputFromMaster:function(){var selectNode=this.selectbox.get(0);var val=selectNode.options[selectNode.selectedIndex].text;this.input.val(val);},revertSelected:function(){this.setInputFromMaster();this.filter(1);},setListDisplay:function(){var listHeight=this.list.outerHeight();var maxHeight=this.listMaxHeight;var height=listHeight;if(height>maxHeight){height=maxHeight;this.listScroll.css(this.overflowCSS,"scroll");}else{this.listScroll.css(this.overflowCSS,"hidden");}this.listScroll.height(height);this.listWrapper.height(height);var doDropUp=false;var offset=this.input.offset();if(this.options.allowDropUp){var listSpace=maxHeight;var inputHeight=this.wrapper.height();var bottomPos=offset.top+inputHeight+listSpace;var maxShown=$(window).height()+$(document).scrollTop();doDropUp=(bottomPos>maxShown);}var top;if(doDropUp){this.listWrapper.addClass("list-wrapper-up");top=(offset.top-this.listScroll.height());}else{this.listWrapper.removeClass("list-wrapper-up");top=(offset.top+this.input.outerHeight()-1);}this.listWrapper.css("left",offset.left);this.listWrapper.css("top",top);return height;},getActive:function(){if(this.selectedLi==null)return $([]);return $(this.selectedLi);},setActive:function(activeItem){$(this.selectedLi).removeClass("active");this.selectedLi=activeItem;$(this.selectedLi).addClass("active");},selectFirst:function(){var toSelect=this.listItems.filter(":not(.invisible):first");this.afterSelect(toSelect);},selectLast:function(){var toSelect=this.listItems.filter(":not(.invisible):last");this.afterSelect(toSelect);},selectPrev:function(isPageLength){var count=isPageLength?this.options.pageLength:1;var toSelect=this.searchRelativeVisible(false,count);this.afterSelect(toSelect);},selectNext:function(isPageLength){var count=isPageLength?this.options.pageLength:1;var toSelect=this.searchRelativeVisible(true,count);this.afterSelect(toSelect);},afterSelect:function(active){this.setActive(active);this.input.val(active.text());this.inputFocus();this.scrollTo();this.tryToSetMaster();},searchRelativeVisible:function(isSearchDown,count){this.log("searchRelative: "+isSearchDown+" : "+count);var active=this.getActive();if(!active.length)return this.selectFirst();var searchResult;do{searchResult=active;do{searchResult=isSearchDown?searchResult.next():searchResult.prev();}while(searchResult.length&&searchResult.hasClass("invisible"));if(searchResult.length)active=searchResult;}while(--count);return active;},scrollTo:function(){if("scroll"!=this.listScroll.css(this.overflowCSS))return;var active=this.getActive();if(!active.length)return;var activePos=Math.floor(active.position().top);var activeHeight=active.outerHeight(true);var listHeight=this.listWrapper.height();var scrollTop=this.listScroll.scrollTop();var top;var viewAheadGap=(this.options.viewAhead*activeHeight);if(activePos<viewAheadGap){top=scrollTop+activePos-viewAheadGap;}else if((activePos+activeHeight)>=(listHeight-viewAheadGap)){top=scrollTop+activePos-listHeight+activeHeight+viewAheadGap;}else return;this.listScroll.scrollTop(top);},getListMaxHeight:function(){var result=parseInt(this.listWrapper.css("max-height"),10);if(isNaN(result)){this.log("no CSS max height set.");result=this.listMaxHeight;}return result;},getCurrentTextValue:function(){var input=$.trim(this.input.val());return input;},stopEvent:function(e){e.cancelBubble=true;e.returnValue=false;if(e.stopPropagation){e.stopPropagation();}if(e.preventDefault){e.preventDefault();}},overwriteClass:function(array,classString){var tritem,index,indexB;index=array.length
while(index--){tritem=array[index];indexB=tritem.length;while(indexB--){tritem[indexB].setAttribute($.ui.ufd.classAttr,classString);}}},listVisible:function(){var isVisible=!this.listWrapper.hasClass("invisible");return isVisible;},disable:function(){this.hideList();this.isDisabled=true;this.button.addClass("disabled");this.input.addClass("disabled");this.input.attr("disabled","disabled");},enable:function(){this.isDisabled=false;this.button.removeClass("disabled");this.input.removeClass("disabled");this.input.removeAttr("disabled");},selection:function(field,start,end){if(field.createTextRange){var selRange=field.createTextRange();selRange.collapse(true);selRange.moveStart("character",start);selRange.moveEnd("character",end);selRange.select();}else if(field.setSelectionRange){field.setSelectionRange(start,end);}else{if(field.selectionStart){field.selectionStart=start;field.selectionEnd=end;}}},selectAll:function(){this.input.get(0).select();},getDropdownContainer:function(){var ddc=$("#"+this.options.dropDownID);if(!ddc.length){ddc=$("<div></div>").appendTo("body").css("height",0).css("z-index",this.options.zIndexPopup).attr("id",this.options.dropDownID);}return ddc;},log:function(msg){if(!this.options.log)return;if(window.console&&console.log){console.log(msg);}if(this.logNode&&this.logNode.length){this.logNode.prepend("<div>"+msg+"</div>");}},changeOptions:function(){this.log("changeOptions");this._populateFromMaster();},destroy:function(){this.log("called destroy");if(this.selectIsWrapped){this.wrapper.before(this.selectbox);}this.wrapper.remove();this.listWrapper.remove();this.element.unbind();$.widget.prototype.destroy.apply(this,arguments);},selectIsWrapped:false,internalFocus:false,lastKey:null,selectedLi:null,isUpdatingMaster:false,isDisabled:false});function Trie(isCaseSensitive){this.isCaseSensitive=isCaseSensitive||false;this.root=[null,{}];};Trie.prototype.cleanString=function(inStr){if(!this.isCaseSensitive){inStr=inStr.toLowerCase();}return inStr;}Trie.prototype.add=function(key,object){key=this.cleanString(key);var curNode=this.root;var kLen=key.length;for(var i=0;i<kLen;i++){var char=key.charAt(i);var node=curNode[1];if(char in node){curNode=node[char];}else{curNode=node[char]=[null,{}];}}if(curNode[0])curNode[0].push(object);else curNode[0]=[object];return true;};Trie.prototype.find=function(key){key=this.cleanString(key);var resultNode=this.findNode(key);return(resultNode)?resultNode[0]:null;};Trie.prototype.findNode=function(key){var results=this.findNodePartial(key);var node=results[0];var remainder=results[1];return(remainder.length>0)?null:node;};Trie.prototype.findNodePartial=function(key){key=this.cleanString(key);var curNode=this.root;var remainder=key;var kLen=key.length;for(var i=0;i<kLen;i++){var char=key.charAt(i);if(char in curNode[1]){curNode=curNode[1][char];}else{return[curNode,remainder];}remainder=remainder.slice(1,remainder.length);}return[curNode,remainder];};Trie.prototype.getValues=function(trieNode){return this.getMissValues(trieNode,null);};Trie.prototype.getMissValues=function(startNode,missNode){if(startNode==null)return[];var stack=[startNode];var results=[];while(stack.length>0){var thisNode=stack.pop();if(thisNode==missNode)continue;if(thisNode[0])results.unshift(thisNode[0]);for(var char in thisNode[1]){if(thisNode[1].hasOwnProperty(char)){stack.push(thisNode[1][char]);}}}return results;};Trie.prototype.findPrefixMatches=function(key){var trieNode=findNode(key);return this.getValues(trieNode);}Trie.prototype.findPrefixMisses=function(key){var trieNode=findNode(key);return this.getMissValues(this.root,trieNode);};Trie.prototype.findPrefixMatchesAndMisses=function(key){var trieNode=this.findNode(key);var matches=this.getValues(trieNode);var misses=this.getMissValues(this.root,trieNode);return{matches:matches,misses:misses};};$.extend($.ui.ufd,{version:"0.4",getter:"",classAttr:(($.support.style)?"class":"className"),defaults:{skin:"plain",suffix:"_ufd",dropDownID:"ufd-container",logSelector:"#log",log:false,submitFreeText:false,triggerSelected:true,caseSensitive:false,allowDropUp:true,allowLR:false,listMaxHeight:200,minWidth:50,manualWidth:null,viewAhead:1,pageLength:10,delayFilter:($.support.style)?1:150,delayYield:1,zIndexPopup:101,css:{input:"",disabled:"disabled",button:"",buttonIcon:"icon",buttonHover:"",buttonMouseDown:"",listWrapper:"",listScroll:"",li:"",liHover:""},uiThemerollerCss:{}}});})(jQuery);